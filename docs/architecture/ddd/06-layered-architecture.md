# 分層架構設計

> **版本**: 1.0
> **最後更新**: 2025-01-08

---

## **7.1 六角架構 (Hexagonal Architecture)**

本系統採用六角架構 (又稱 Ports and Adapters)，確保領域邏輯獨立於技術實現：

```
┌──────────────────────────────────────────────────────────────┐
│                       Presentation Layer                       │
│                         (展示層)                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  LINE Bot    │  │  Admin Web   │  │  REST API    │       │
│  │  Webhook     │  │  Frontend    │  │  Endpoints   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│         ▲                  ▲                  ▲               │
│         │                  │                  │               │
│         └──────────────────┴──────────────────┘               │
│                            │                                  │
└────────────────────────────┼──────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────┐
│                       Application Layer                        │
│                         (應用層)                                │
│  ┌───────────────────────────────────────────────────────┐   │
│  │         Application Services (Use Cases)               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │  Member     │  │  Points     │  │  Invoice    │   │   │
│  │  │  AppService │  │  AppService │  │  AppService │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └───────────────────────────────────────────────────────┘   │
│                            │                                  │
│  ┌───────────────────────────────────────────────────────┐   │
│  │            Command / Query Handlers                    │   │
│  │         (CQRS Pattern - 讀寫分離)                       │   │
│  └───────────────────────────────────────────────────────┘   │
│                            │                                  │
└────────────────────────────┼──────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────┐
│                        Domain Layer                            │
│                         (領域層)                                │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                  Bounded Contexts                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │  Member  │  │  Points  │  │  Invoice │  ...       │   │
│  │  │  Context │  │  Context │  │  Context │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘            │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                Aggregates & Entities                   │   │
│  │  - Member, PointsAccount, InvoiceTransaction, ...     │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                  Value Objects                         │   │
│  │  - MemberID, PointsAmount, InvoiceNumber, ...         │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                Domain Services                         │   │
│  │  - PointsCalculationService                           │   │
│  │  - InvoiceValidationService                           │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │               Repository Interfaces                    │   │
│  │  (Port - 由基礎設施層實現)                              │   │
│  └───────────────────────────────────────────────────────┘   │
│                            │                                  │
└────────────────────────────┼──────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────┐
│                   Infrastructure Layer                         │
│                      (基礎設施層)                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │              Repository Implementations                │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │  GORM       │  │  Redis      │  │  Mock       │   │   │
│  │  │  Repository │  │  Repository │  │  Repository │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │               External Service Adapters                │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │  LINE SDK   │  │  Google     │  │  iChef API  │   │   │
│  │  │  Adapter    │  │  OAuth      │  │  Adapter    │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                 Event Bus / Message Queue              │   │
│  │         (未來可替換為 RabbitMQ/Kafka)                   │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                    Database                            │   │
│  │       PostgreSQL / SQLite (開發環境)                   │   │
│  └───────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

## **7.2 層次職責定義**

### **展示層 (Presentation Layer)**
- **職責**: 處理外部請求，轉換為應用層命令/查詢
- **組件**:
  - LINE Bot Webhook Handler
  - REST API Controllers
  - GraphQL Resolvers (未來)
- **原則**:
  - 不包含業務邏輯
  - 只負責協議轉換 (HTTP ↔ 應用服務)
  - 輸入驗證 (格式、型別)

### **應用層 (Application Layer)**
- **職責**: 協調領域對象完成用例，管理事務
- **組件**:
  - Application Services (每個用例一個方法)
  - Command Handlers (處理寫入操作)
  - Query Handlers (處理讀取操作)
  - Event Handlers (訂閱領域事件)
  - **DTOs (Data Transfer Objects)**: 跨層/跨上下文數據傳輸
- **原則**:
  - 薄薄一層，不包含業務規則
  - 編排領域對象和領域服務
  - 管理事務邊界
  - 發布領域事件到事件總線
  - 負責 DTO ↔ Domain Entity 轉換

### **領域層 (Domain Layer)**
- **職責**: 封裝核心業務邏輯與規則
- **組件**:
  - Aggregates (聚合根)
  - Entities (實體)
  - Value Objects (值對象)
  - Domain Services (領域服務)
  - Repository Interfaces (倉儲接口)
  - Domain Events (領域事件)
- **原則**:
  - 純粹的業務邏輯，無基礎設施依賴
  - 使用統一語言 (Ubiquitous Language)
  - 聚合根保護不變性規則
  - 充血模型 (Rich Domain Model)

### **基礎設施層 (Infrastructure Layer)**
- **職責**: 提供技術實現，支撐上層
- **組件**:
  - Repository Implementations (GORM, Redis)
  - External Service Adapters (LINE SDK, Google OAuth)
  - Event Bus / Message Queue
  - Database Migrations
  - Configuration Management
- **原則**:
  - 實現領域層定義的接口
  - 可替換性 (Pluggable)
  - 不洩漏到上層
