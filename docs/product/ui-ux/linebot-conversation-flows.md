# 💬 LINE Bot 對話流程設計

本文件詳細描述「餐廳會員管理 Line Bot」的所有對話流程、訊息格式和使用者體驗設計。

---

## 📋 目錄

1. [註冊流程](#註冊流程)
2. [QR Code 掃描流程](#qr-code-掃描流程)
3. [積分查詢流程](#積分查詢流程)
4. [錯誤處理流程](#錯誤處理流程)
5. [訊息格式規範](#訊息格式規範)

---

## 🎯 設計目標

- **簡單直覺**: 用戶無需學習，自然對話即可完成操作
- **即時反饋**: 每個操作都有明確的回應
- **容錯設計**: 錯誤訊息清楚，提供解決方案
- **狀態管理**: 記錄會話狀態，支援中斷恢復

---

## 註冊流程

### **流程概述**

```
加入好友 → 歡迎訊息 → 輸入手機號碼 → 驗證格式 → 註冊成功
```

### **詳細對話流程**

#### **步驟 1: 用戶加入好友（Follow Event）**

**觸發**: 用戶點擊「加入好友」

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ 🎉 歡迎加入 [餐廳名稱] 會員系統！  │
│                                     │
│ 透過本系統，您可以：                │
│ 📸 掃描發票 QR Code 賺取積分       │
│ 💰 隨時查詢您的積分餘額             │
│ 📋 參與問卷調查獲得額外獎勵         │
│                                     │
│ ────────────────────────            │
│                                     │
│ 請輸入您的手機號碼完成註冊：        │
│ （格式：0912345678，10 位數字）    │
└─────────────────────────────────────┘
```

**設計考量**:
- 使用 emoji 增加親和力
- 清楚列出功能價值
- 明確說明手機號碼格式

---

#### **步驟 2: 用戶輸入手機號碼**

**用戶輸入**: `0912345678`

**系統處理**:
1. 驗證格式（10 位數，09 開頭）
2. 檢查是否已註冊（LINE ID 或手機號碼）
3. 創建用戶記錄

**成功回應**:
```
┌─────────────────────────────────────┐
│ ✅ 註冊成功！                       │
│                                     │
│ 會員資訊：                          │
│ • 暱稱：王小明                      │
│ • 手機：0912***678                  │
│ • 註冊時間：2025/01/08              │
│                                     │
│ ────────────────────────            │
│                                     │
│ 現在您可以：                        │
│                                     │
│ 📸 上傳發票 QR Code                │
│    → 直接傳送發票照片即可           │
│                                     │
│ 💰 查詢積分                         │
│    → 輸入「積分」或「點數」         │
│                                     │
│ 立即開始賺取積分吧！ 🎊             │
└─────────────────────────────────────┘
```

**設計考量**:
- 確認註冊資訊（手機號碼遮罩保護隱私）
- 提供下一步操作指引
- 使用慶祝 emoji 增加儀式感

---

#### **錯誤場景: 手機號碼格式錯誤**

**用戶輸入**: `123456` 或 `0812345678`

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ❌ 手機號碼格式錯誤                 │
│                                     │
│ 請輸入正確的台灣手機號碼：          │
│ • 必須是 10 位數字                  │
│ • 以 09 開頭                        │
│                                     │
│ 範例：0912345678                    │
│                                     │
│ 請重新輸入：                        │
└─────────────────────────────────────┘
```

---

#### **錯誤場景: 手機號碼已被使用**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ⚠️  此手機號碼已被註冊              │
│                                     │
│ 每個手機號碼只能綁定一個 LINE 帳號。│
│                                     │
│ 如有問題，請聯繫餐廳人員：          │
│ 📞 (02) 1234-5678                   │
│ ✉️  service@restaurant.com          │
└─────────────────────────────────────┘
```

---

### **流程圖**

```
┌─────────────┐
│ 加入好友     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 歡迎訊息     │
│ (說明功能)   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 輸入手機號碼 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 驗證格式     │
└──┬────┬─────┘
   │    │
   │    │ (格式錯誤)
   │    ▼
   │  ┌─────────────┐
   │  │ 錯誤訊息     │
   │  │ 請重新輸入   │
   │  └──────┬──────┘
   │         │
   │         └──────┐
   │ (格式正確)      │
   ▼                │
┌─────────────┐     │
│ 檢查重複     │     │
└──┬────┬─────┘     │
   │    │           │
   │    │ (已註冊)  │
   │    ▼           │
   │  ┌─────────────┐
   │  │ 錯誤訊息     │◄──┘
   │  │ 聯繫客服     │
   │  └─────────────┘
   │ (未註冊)
   ▼
┌─────────────┐
│ 註冊成功     │
│ 顯示操作指引 │
└─────────────┘
```

---

## QR Code 掃描流程

### **流程概述**

```
上傳圖片 → 解析 QR Code → 驗證發票 → 創建交易 → 顯示結果 + 問卷連結
```

### **詳細對話流程**

#### **步驟 1: 用戶上傳發票照片（Image Message）**

**觸發**: 用戶傳送圖片訊息

**Bot 即時回應**:
```
┌─────────────────────────────────────┐
│ 🔍 正在解析 QR Code，請稍候...      │
└─────────────────────────────────────┘
```

**設計考量**:
- 立即反饋，告知系統正在處理
- 使用 emoji 和載入提示增加互動感

---

#### **步驟 2: 成功解析並驗證發票**

**系統處理**:
1. 解析 QR Code 提取發票資訊
2. 驗證發票格式、有效期（60 天）
3. 檢查重複
4. 計算預估積分
5. 檢查是否有啟用的問卷

**成功回應 (無問卷)**:
```
┌─────────────────────────────────────┐
│ ✅ 發票資訊確認                     │
│                                     │
│ 發票號碼：AB-12345678               │
│ 消費日期：2025/01/05                │
│ 消費金額：NT$ 250                   │
│                                     │
│ ────────────────────────            │
│                                     │
│ 預估可獲得積分：2 點                │
│                                     │
│ 📌 狀態：待驗證                     │
│ 此發票將在店家匯入 POS 系統資料後   │
│ 自動驗證，積分將於驗證後入帳。      │
│                                     │
│ 您可以隨時輸入「積分」查詢最新狀態  │
└─────────────────────────────────────┘
```

**成功回應 (有問卷)**:
```
┌─────────────────────────────────────┐
│ ✅ 發票資訊確認                     │
│                                     │
│ 發票號碼：AB-12345678               │
│ 消費日期：2025/01/05                │
│ 消費金額：NT$ 250                   │
│                                     │
│ ────────────────────────────────────│
│                                     │
│ 預估可獲得積分：2 點                │
│                                     │
│ 📋 填寫問卷可再得 1 點！             │
│                                     │
│ 請點擊連結填寫滿意度問卷：          │
│ https://example.com/survey?token=...│
│                                     │
│ （問卷約 2 分鐘，完成後積分自動增加）│
│                                     │
│ ────────────────────────────────────│
│                                     │
│ 📌 狀態：待驗證                     │
│ 此發票將在店家匯入 POS 系統資料後   │
│ 自動驗證。                          │
└─────────────────────────────────────┘
```

**設計考量**:
- 清楚顯示發票關鍵資訊
- 分層顯示（發票資訊 → 積分 → 問卷 → 狀態說明）
- 使用分隔線區分不同區塊
- 強調問卷獎勵吸引參與

---

#### **特殊場景: 發票已驗證（雙向驗證 - 店家先匯入）**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ✅ 發票已驗證                       │
│                                     │
│ 發票號碼：AB-12345678               │
│ 消費日期：2025/01/05                │
│ 消費金額：NT$ 250                   │
│                                     │
│ ────────────────────────────────────│
│                                     │
│ 🎉 已獲得積分：2 點                 │
│                                     │
│ 此發票已通過系統驗證，積分已入帳！  │
│                                     │
│ 📋 填寫問卷可再得 1 點！             │
│ https://example.com/survey?token=...│
│                                     │
│ 輸入「積分」查看最新餘額             │
└─────────────────────────────────────┘
```

**設計考量**:
- 慶祝已驗證狀態（🎉）
- 區分「預估」與「已獲得」
- 鼓勵查詢積分

---

#### **錯誤場景 1: 無法辨識 QR Code**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ❌ 未找到 QR Code                   │
│                                     │
│ 請確認照片清晰可見，並包含完整的    │
│ 發票 QR Code。                      │
│                                     │
│ 💡 拍照小技巧：                     │
│ • 確保光線充足                      │
│ • 對準 QR Code                      │
│ • 避免反光或陰影                    │
│ • QR Code 完整出現在畫面中          │
│                                     │
│ 請重新上傳照片                      │
└─────────────────────────────────────┘
```

---

#### **錯誤場景 2: 發票已過期**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ⏰ 發票已超過有效期限                │
│                                     │
│ 發票號碼：AB-12345678               │
│ 消費日期：2024/10/01                │
│                                     │
│ 很抱歉，此發票開立日期已超過 60 天， │
│ 無法獲得積分。                      │
│                                     │
│ 發票有效期：開立日期起 60 天內      │
│                                     │
│ 歡迎您下次消費時即時掃描發票！      │
└─────────────────────────────────────┘
```

---

#### **錯誤場景 3: 重複發票**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ⚠️  此發票已被登錄                  │
│                                     │
│ 發票號碼：AB-12345678               │
│ 首次登錄時間：2025/01/05 14:30      │
│                                     │
│ 每張發票只能獲得一次積分。          │
│                                     │
│ 輸入「積分」查看您的積分記錄         │
└─────────────────────────────────────┘
```

---

### **流程圖**

```
┌─────────────┐
│ 上傳圖片     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 顯示解析中   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 解析 QR Code │
└──┬────┬─────┘
   │    │
   │    │ (找不到 QR Code)
   │    ▼
   │  ┌─────────────┐
   │  │ 錯誤訊息     │
   │  │ 拍照建議     │
   │  └─────────────┘
   │ (成功解析)
   ▼
┌─────────────┐
│ 驗證發票     │
│ (日期/重複)  │
└──┬────┬─────┘
   │    │
   │    │ (過期/重複)
   │    ▼
   │  ┌─────────────┐
   │  │ 錯誤訊息     │
   │  └─────────────┘
   │ (驗證通過)
   ▼
┌─────────────┐
│ 檢查 iChef   │
│ 記錄         │
└──┬────┬─────┘
   │    │
   │    │ (已有記錄)
   │    ▼
   │  ┌─────────────┐
   │  │ 顯示已驗證   │
   │  │ 積分已入帳   │
   │  └─────────────┘
   │ (無記錄)
   ▼
┌─────────────┐
│ 創建交易     │
│ status=imported
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 檢查問卷     │
└──┬────┬─────┘
   │    │
   │    │ (有啟用問卷)
   │    ▼
   │  ┌─────────────┐
   │  │ 顯示結果 +   │
   │  │ 問卷連結     │
   │  └─────────────┘
   │ (無問卷)
   ▼
┌─────────────┐
│ 顯示結果     │
│ (待驗證狀態) │
└─────────────┘
```

---

## 積分查詢流程

### **流程概述**

```
輸入關鍵字 → 查詢積分 → 顯示詳細資訊
```

### **詳細對話流程**

#### **觸發關鍵字**

用戶可輸入以下任一關鍵字觸發查詢：
- `積分`
- `點數`
- `查詢積分`
- `我的積分`
- `餘額`

---

#### **成功回應**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ 💰 您的積分資訊                     │
│                                     │
│ 累積賺取：125 點                    │
│ 已使用：0 點                        │
│ 可用餘額：125 點                    │
│                                     │
│ ════════════════════════════════════│
│                                     │
│ 📊 統計資訊                         │
│                                     │
│ • 已驗證交易：48 筆                 │
│   （基礎積分：90 點）               │
│                                     │
│ • 已完成問卷：35 筆                 │
│   （問卷獎勵：35 點）               │
│                                     │
│ • 待驗證交易：2 筆                  │
│   （預估積分：3 點，待驗證後入帳）  │
│                                     │
│ ════════════════════════════════════│
│                                     │
│ 💡 繼續賺取積分：                   │
│ • 上傳發票 QR Code                  │
│ • 填寫問卷調查                      │
│                                     │
│ 查詢時間：2025/01/08 15:30          │
└─────────────────────────────────────┘
```

**設計考量**:
- 分層顯示積分資訊（總覽 → 詳細統計 → 行動建議）
- 使用雙線分隔不同區塊
- 顯示查詢時間（透明度）
- 提供行動建議（增加參與度）

---

#### **場景: 新用戶（無積分）**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ 💰 您的積分資訊                     │
│                                     │
│ 累積賺取：0 點                      │
│ 已使用：0 點                        │
│ 可用餘額：0 點                      │
│                                     │
│ ════════════════════════════════════│
│                                     │
│ 🎊 立即開始賺取積分！               │
│                                     │
│ 📸 上傳發票 QR Code                │
│    → 直接傳送發票照片               │
│    → 每 100 元可得 1 點             │
│                                     │
│ 📋 完成問卷調查                     │
│    → 每份問卷額外 +1 點             │
│                                     │
│ 越早開始，累積越多！                │
└─────────────────────────────────────┘
```

**設計考量**:
- 針對新用戶提供操作指引
- 說明積分獲得方式和價值
- 鼓勵行動

---

### **流程圖**

```
┌─────────────┐
│ 輸入關鍵字   │
│ (積分/點數)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 檢查用戶註冊 │
└──┬────┬─────┘
   │    │
   │    │ (未註冊)
   │    ▼
   │  ┌─────────────┐
   │  │ 提示先註冊   │
   │  └─────────────┘
   │ (已註冊)
   ▼
┌─────────────┐
│ 查詢積分資料 │
└──┬────┬─────┘
   │    │
   │    │ (有積分)
   │    ▼
   │  ┌─────────────┐
   │  │ 顯示詳細統計 │
   │  └─────────────┘
   │ (無積分)
   ▼
┌─────────────┐
│ 顯示新用戶   │
│ 操作指引     │
└─────────────┘
```

---

## 錯誤處理流程

### **未註冊用戶嘗試操作**

**場景**: 未完成註冊的用戶上傳發票或查詢積分

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ⚠️  請先完成註冊                    │
│                                     │
│ 您尚未綁定手機號碼，無法使用此功能。│
│                                     │
│ 請輸入您的手機號碼完成註冊：        │
│ （格式：0912345678）                │
└─────────────────────────────────────┘
```

---

### **系統錯誤**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ ❌ 系統處理中發生錯誤               │
│                                     │
│ 很抱歉，系統暫時無法處理您的請求。  │
│ 請稍後再試，或聯繫客服人員。        │
│                                     │
│ 📞 客服電話：(02) 1234-5678         │
│ ✉️  Email：service@restaurant.com   │
│                                     │
│ 錯誤代碼：ERR-001-20250108-153045   │
│ （提供此代碼以加速處理）            │
└─────────────────────────────────────┘
```

**設計考量**:
- 提供錯誤代碼便於追蹤
- 提供聯繫方式
- 語氣友善，表達歉意

---

### **網路連線問題**

**Bot 回應**:
```
┌─────────────────────────────────────┐
│ 🔌 網路連線異常                     │
│                                     │
│ 請檢查您的網路連線，並重新嘗試。    │
│                                     │
│ 如問題持續發生，請聯繫客服。        │
└─────────────────────────────────────┘
```

---

## 訊息格式規範

### **訊息結構**

```
標題（必要）
├─ 使用 emoji
└─ 簡短明確

內容區塊（必要）
├─ 關鍵資訊
├─ 分隔線（可選）
└─ 補充說明

行動建議（可選）
└─ 下一步操作

時間戳記（可選）
└─ 顯示時間或狀態
```

### **Emoji 使用規範**

| 情境 | Emoji | 使用時機 |
|------|-------|---------|
| 成功 | ✅ | 操作成功、驗證通過 |
| 慶祝 | 🎉 🎊 | 註冊成功、積分入帳 |
| 錯誤 | ❌ | 操作失敗、格式錯誤 |
| 警告 | ⚠️ | 重複操作、權限不足 |
| 資訊 | 💡 ℹ️ | 提示、建議 |
| 處理中 | 🔍 ⏳ | 系統處理、載入中 |
| 積分 | 💰 💎 | 積分相關資訊 |
| 問卷 | 📋 📝 | 問卷相關 |
| 發票 | 📸 🧾 | 發票相關 |
| 時間 | ⏰ 📅 | 時間、日期 |

### **文字格式規範**

1. **數字與金額**
   - 積分：`125 點`（阿拉伯數字 + 空格 + 單位）
   - 金額：`NT$ 250`（貨幣符號 + 空格 + 數字）
   - 日期：`2025/01/08`（ISO 格式簡化版）

2. **狀態標示**
   - 使用 `📌` 或 `•` 作為列表符號
   - 狀態使用：`待驗證`、`已驗證`、`作廢`

3. **分隔線**
   - 使用 `────────────────────────` 區分區塊
   - 使用 `════════════════════════════════════` 強調重要分隔

4. **強調文字**
   - 避免使用全形驚嘆號（！）過多
   - 重要資訊可使用數字或符號突顯

---

## 訊息發送時機

### **即時訊息**

1. **用戶觸發**: 立即回應（< 2 秒）
2. **系統處理**: 先發送「處理中」訊息，完成後發送結果

### **非同步訊息**

1. **發票驗證完成**: iChef 匯入後自動通知
```
┌─────────────────────────────────────┐
│ 🎉 您的發票已驗證！                 │
│                                     │
│ 發票號碼：AB-12345678               │
│ 獲得積分：2 點                      │
│                                     │
│ 您的最新積分餘額：127 點            │
│                                     │
│ 感謝您的支持！                      │
└─────────────────────────────────────┘
```

2. **促銷活動通知**: 管理員發送廣播訊息
```
┌─────────────────────────────────────┐
│ 🎁 積分雙倍送活動開跑！             │
│                                     │
│ 活動期間：2025/01/10 - 01/20        │
│                                     │
│ 掃描發票可獲得 2 倍積分！           │
│ （原本 100 元 = 1 點，活動期間 50 元 = 1 點）
│                                     │
│ 立即掃描發票，賺取更多積分！        │
└─────────────────────────────────────┘
```

---

## 會話狀態管理

### **狀態類型**

| 狀態 | 說明 | 超時時間 |
|------|------|---------|
| `IDLE` | 閒置（無進行中操作） | - |
| `REGISTRATION` | 註冊流程中（等待輸入手機號碼） | 5 分鐘 |
| `QR_SCANNING` | QR Code 處理中 | - |
| `AWAITING_CONFIRMATION` | 等待用戶確認（如資料修正） | 10 分鐘 |

### **狀態儲存**

- 使用 Redis 儲存會話狀態
- Key 格式：`linebot:session:{lineUserID}`
- TTL：根據狀態類型設定

### **超時處理**

超時後發送提示訊息並清除狀態：
```
┌─────────────────────────────────────┐
│ ⏰ 操作已逾時                       │
│                                     │
│ 您的操作已超過時間限制。            │
│ 如需繼續，請重新開始。              │
│                                     │
│ 需要協助嗎？輸入「幫助」查看功能說明│
└─────────────────────────────────────┘
```

---

## 多媒體訊息設計

### **Rich Menu（選單按鈕）**

建議設計（可選功能）：

```
┌─────────────┬─────────────┐
│             │             │
│   📸 掃描    │   💰 積分    │
│   發票      │   查詢      │
│             │             │
├─────────────┼─────────────┤
│             │             │
│   📋 我的    │   ℹ️  關於   │
│   問卷      │   我們      │
│             │             │
└─────────────┴─────────────┘
```

### **Flex Message（進階訊息）**

可用於顯示複雜資訊（如積分排行榜、優惠活動）：

```json
{
  "type": "bubble",
  "hero": {
    "type": "image",
    "url": "https://example.com/promo.jpg"
  },
  "body": {
    "type": "box",
    "layout": "vertical",
    "contents": [
      {
        "type": "text",
        "text": "本月積分排行榜",
        "weight": "bold",
        "size": "xl"
      }
    ]
  }
}
```

---

## 🔗 相關文件

- [US-001: 帳號綁定](../stories/US-001-account-binding.md)
- [US-002: QR Code 掃描](../stories/US-002-qr-code-scanning-points.md)
- [US-003: 積分查詢](../stories/US-003-points-balance-query.md)
- [US-004: 問卷系統](../stories/US-004-survey-system.md)
- [LINE Messaging API](https://developers.line.biz/en/docs/messaging-api/)
- [LINE Design System](https://designsystem.line.me/)

---

**文件版本**: V3.1
**最後更新**: 2025-01-08
**維護者**: Product Team & UX Designer
