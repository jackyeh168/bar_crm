# **產品需求文件 (PRD): 餐廳會員管理 Line Bot**

*   **版本**: 3.1
*   **最後更新**: 2025-01-08
*   **產品負責人**: Sarah

---

## **1. 綜覽**

### **1.1 產品目標**

建立一個 LINE Bot 會員管理系統，整合積分管理、問卷調查、POS 系統匯入等功能，提升顧客參與度、簡化營運流程、強化品牌忠誠度，並提供完整的管理後台進行資料分析與營運決策。

### **1.2 產品背景**

在競爭激烈的餐飲市場，提升顧客參與度與營運效率是關鍵。傳統的會員卡或獨立 App 模式過於複雜，POS 系統資料無法與會員系統整合，導致營運效率低落。本系統利用台灣高普及率的 LINE 平台，提供：

- **顧客端**: 簡單的帳號綁定、便捷的 QR Code 掃描積分、即時的積分查詢、滿意度問卷調查
- **營運端**: 完整的管理後台、iChef POS 系統整合、彈性的積分轉換率設定、資料驗證與分析

### **1.3 成功指標 (Success Metrics)**

| 指標 (Metric) | 衡量方式 | 目標 (上線後3個月) |
| :--- | :--- | :--- |
| **用戶註冊率** | 完成帳號綁定的用戶數 / 關注 Bot 用戶數 | > 40% |
| **QR Code 掃描參與度** | 每月掃描 QR Code 的會員數 / 總會員數 | > 60% |
| **積分查詢活躍度** | 每月查詢積分的會員數 / 總會員數 | > 80% |
| **問卷完成率** | 完成問卷的會員數 / 收到問卷的會員數 | > 30% |
| **iChef 驗證率** | iChef 匹配成功的發票數 / QR 掃描發票數 | > 85% |
| **用戶留存率** | 30天內重複使用的會員數 / 總會員數 | > 50% |
| **系統穩定性** | 功能成功執行率 | > 99.9% |

### **1.4 使用者畫像 (User Personas)**

#### **畫像一：常客小陳 (忠誠顧客)**
*   **背景**: 25-35歲上班族，每週至少光顧2次。
*   **動機**: 喜歡這家餐廳，希望能簡單快速地累積積分。
*   **期望**: 簡單的操作流程，能隨時查看積分，透過掃描 QR Code 輕鬆獲得獎勵，願意填寫問卷提供意見。

#### **畫像二：新客小美 (潛在顧客)**
*   **背景**: 20-30歲學生或社會新鮮人，首次或第二次光顧。
*   **動機**: 對新的科技體驗感興趣，願意嘗試 QR Code 掃描功能。
*   **期望**: 能快速完成註冊，立即開始使用積分功能，操作簡單直觀。

#### **畫像三：店長王姐 (營運管理者)**
*   **背景**: 35-45歲餐廳店長，負責日常營運與會員管理。
*   **動機**: 希望能快速查看會員資料、交易記錄、問卷回饋，並驗證發票資料。
*   **期望**: 簡單易用的管理後台，可以批次匯入 iChef 資料，查看積分統計，設定促銷活動的積分轉換率。

---

## **2. 使用者故事與功能需求 (User Stories & Features)**

> **技術實作細節**: 詳細的架構設計、資料模型和 API 規格請參考 [SYSTEM_DESIGN.md](../architecture/SYSTEM_DESIGN.md)

### **核心功能 1: 帳號綁定**

> **USER STORY 1: 帳號綁定**
>
> *   **身為** 一位新顧客 (小美)，
> *   **我想要** 透過提供手機號碼來快速完成會員註冊，
> *   **以便** 我能開始使用所有會員功能。

#### **驗收條件**

**成功場景：首次註冊**
1. `Given` 新使用者加入 LINE Bot，`When` 點擊「加入好友」，`Then` 收到歡迎訊息並提示輸入手機號碼
2. `Given` 使用者輸入 10 位數手機號碼（09 開頭），`When` 提交註冊，`Then` 顯示註冊成功訊息並說明如何使用積分功能
3. `Given` 註冊成功，`When` 查詢會員資料，`Then` 系統記錄 LINE ID、顯示名稱和手機號碼的綁定關係

**失敗場景：手機號碼格式錯誤**
1. `Given` 使用者輸入非 10 位數字或非 09 開頭的號碼，`When` 提交註冊，`Then` 顯示錯誤訊息「手機號碼格式錯誤，請輸入 10 位數字，以 09 開頭」

**失敗場景：手機號碼已被使用**
1. `Given` 使用者輸入已註冊的手機號碼，`When` 提交註冊，`Then` 顯示錯誤訊息「此手機號碼已被註冊」

**業務規則**
- 每個 LINE 帳號只能綁定一個手機號碼
- 每個手機號碼只能綁定一個 LINE 帳號
- 手機號碼格式：10 位數字，09 開頭（台灣手機號碼）
- 註冊後無法自行解除綁定（需聯繫管理員）

---

### **核心功能 2: QR Code 掃描與積分計算**

> **USER STORY 2: QR Code 掃描與積分計算**
>
> *   **身為** 一位會員 (小陳)，
> *   **我想要** 上傳包含消費金額 QR Code 的照片來自動計算並獲得積分，
> *   **以便** 我能根據消費金額輕鬆累積相對應的積分獎勵，並收到問卷連結。

#### **積分計算規則**

**基本公式**:
```
單筆交易基礎積分 = 消費金額 ÷ 轉換率（無條件捨去小數）
問卷獎勵積分 = 1 點（完成問卷後獲得）
累積總積分 = 所有已驗證交易的積分總和
```

**積分轉換率**:
- 預設轉換率：100 元 = 1 點
- 管理員可設定不同時期的轉換率（如促銷期間 50 元 = 1 點）
- 系統根據發票日期自動套用對應時期的轉換率

**計算範例**:
- 消費 $250（轉換率 100）→ 基礎積分 2 點
- 消費 $250 + 完成問卷 → 總積分 3 點（2 基礎 + 1 問卷）
- 消費 $180（轉換率 50）→ 基礎積分 3 點
- 消費 $99（轉換率 100）+ 完成問卷 → 總積分 1 點（0 基礎 + 1 問卷）

#### **驗收條件**

**成功場景：掃描有效發票**
1. `Given` 會員上傳發票 QR Code 照片，`When` 系統解析 QR Code，`Then` 提取發票號碼、日期、金額並顯示確認訊息
2. `Given` 發票未重複且在 60 天有效期內，`When` 系統處理發票，`Then`
   - 記錄交易（狀態：待驗證）
   - 計算預估積分並顯示
   - 若有啟用問卷，提供問卷連結
3. `Given` 發票已通過 iChef 系統驗證，`When` 管理員匯入 iChef 資料，`Then` 交易狀態更新為「已驗證」並自動計入累積積分

**失敗場景：QR Code 無效**
1. `Given` 會員上傳的照片無法辨識 QR Code，`When` 系統處理，`Then` 顯示「未找到 QR Code，請重新上傳清晰的照片」

**失敗場景：發票已過期**
1. `Given` 發票日期超過 60 天，`When` 系統驗證，`Then` 顯示「發票已超過有效期限（60天），無法獲得積分」

**失敗場景：重複發票**
1. `Given` 發票已被登錄過，`When` 系統檢查，`Then` 顯示「此發票已被登錄，無法重複獲得積分」

**業務規則**
- 發票有效期：開立日期起 60 天內
- 重複檢測：同一發票號碼只能登錄一次
- 積分計算：使用發票日期對應的轉換率規則
- 積分狀態：「待驗證」交易不計入累積積分，需等待 iChef 系統驗證
- 問卷獎勵：每筆交易最多獲得 1 點問卷獎勵

---

### **核心功能 3: 積分餘額查詢**

> **USER STORY 3: 積分餘額查詢**
>
> *   **身為** 一位會員 (小陳)，
> *   **我想要** 查詢我目前的累積積分，
> *   **以便** 我能了解可用的點數數量。

#### **驗收條件**

**成功場景：查詢積分**
1. `Given` 會員發送「積分」關鍵字，`When` 系統處理查詢，`Then` 顯示以下資訊：
   - 累積賺取積分
   - 已使用積分
   - 可用積分餘額

**業務規則**
- 顯示積分：累積賺取積分（所有已驗證交易的積分總和）
- 可用積分 = 累積賺取積分 - 已使用積分
- 查詢無需費用，可隨時查詢

---

### **核心功能 4: 問卷調查系統**

> **USER STORY 4: 問卷調查與獎勵**
>
> *   **身為** 一位會員 (小陳)，
> *   **我想要** 填寫餐廳滿意度問卷，
> *   **以便** 我能分享我的意見，並獲得額外 1 點積分獎勵。

#### **驗收條件**

**成功場景：完成問卷**
1. `Given` 會員掃描發票後收到問卷連結，`When` 點擊連結，`Then` 開啟問卷填寫頁面
2. `Given` 會員填寫所有必填題並提交，`When` 系統驗證完整性，`Then`
   - 顯示「感謝您的回饋」訊息
   - 若交易已驗證，立即增加 1 點積分
   - 若交易未驗證，待驗證後自動增加 1 點積分

**失敗場景：重複填寫**
1. `Given` 會員已填寫過此交易的問卷，`When` 再次嘗試填寫，`Then` 顯示「您已填寫過此問卷」

**業務規則**
- 問卷題型：文字題、選擇題、評分題（1-5 星）
- 獎勵規則：每筆交易問卷獎勵 1 點
- 唯一性：同一筆交易的問卷只能填寫一次
- 啟用控制：管理員可設定問卷是否啟用
- 無登入填寫：使用 Token 認證，無需登入

---

### **核心功能 5: iChef POS 系統整合**

> **USER STORY 5: iChef 發票驗證**
>
> *   **身為** 店長 (王姐)，
> *   **我想要** 批次匯入 iChef POS 系統的發票資料，
> *   **以便** 自動驗證會員掃描的發票，並自動計算正確的積分。

#### **驗收條件**

**成功場景：匯入 iChef 資料**
1. `Given` 店長從 iChef 系統匯出 Excel 發票資料，`When` 上傳到管理後台，`Then` 系統顯示匯入摘要：
   - 總筆數
   - 成功匹配筆數（與會員掃描記錄匹配）
   - 未匹配筆數（無對應掃描記錄）
   - 重複筆數（已匯入過）
   - 跳過筆數（無效格式）
2. `Given` 匯入的發票與會員掃描記錄匹配，`When` 系統驗證，`Then`
   - 交易狀態從「待驗證」更新為「已驗證」
   - 自動計入會員累積積分

**業務規則**
- 匹配條件：發票號碼、日期、金額三者完全一致
- 重複檢測：相同發票（號碼+日期+金額）只能匯入一次
- 狀態流轉：「待驗證」→「已驗證」（匹配成功）或「已驗證」→「作廢」（發票作廢）
- 積分重算：狀態變更後自動觸發積分重算
- 雙向驗證：會員可先掃描 QR Code，店家後續驗證；或店家先匯入，會員掃描時自動驗證

---

### **核心功能 6: 管理後台系統**

> **USER STORY 6: 管理後台操作**
>
> *   **身為** 店長 (王姐) 或管理員，
> *   **我想要** 透過網頁管理後台查看和管理會員資料、交易記錄、問卷回應，
> *   **以便** 我能進行營運分析與決策。

#### **6.1 認證與授權**

**驗收條件**:
1. `Given` 管理員使用 Google 帳號登入，`When` 驗證成功，`Then` 系統分配角色（Admin/User/Guest）並產生訪問權限
2. `Given` 首位登入的使用者 email 符合 DEFAULT_ADMIN_EMAIL，`When` 首次登入，`Then` 自動授予 Admin 角色
3. `Given` 非管理員使用者，`When` 嘗試訪問受限功能，`Then` 顯示「權限不足」錯誤

**角色權限**:
- **Admin**: 完整權限（CRUD 所有資源、設定積分規則、管理用戶角色）
- **User**: 唯讀權限（查看會員、交易、問卷資料）
- **Guest**: 受限唯讀（僅查看公開統計數據）

#### **6.2 會員管理**

**驗收條件**:
1. `Given` 管理員訪問會員列表，`When` 查詢，`Then` 顯示分頁列表（顯示 LINE ID、暱稱、手機號碼、累積積分）
2. `Given` 管理員搜尋特定會員，`When` 輸入手機號碼或暱稱，`Then` 過濾並顯示匹配結果
3. `Given` 管理員查看會員詳情，`When` 點擊會員，`Then` 顯示交易歷史和問卷回應記錄

#### **6.3 交易管理**

**驗收條件**:
1. `Given` 管理員查看交易列表，`When` 查詢，`Then` 顯示所有交易（含發票號碼、日期、金額、狀態、積分）
2. `Given` 管理員篩選特定狀態，`When` 選擇「待驗證」，`Then` 僅顯示待驗證交易
3. `Given` 管理員手動更新交易狀態，`When` 將「待驗證」改為「已驗證」，`Then` 系統自動重算會員積分

**業務規則**:
- 狀態流轉限制：「待驗證」可改為「已驗證」或「作廢」；「已驗證」可改為「作廢」；「作廢」無法恢復
- 積分同步：狀態變更後立即觸發積分重算

#### **6.4 問卷管理**

**驗收條件**:
1. `Given` 管理員創建新問卷，`When` 輸入標題、題目和選項，`Then` 系統保存並分配唯一 ID
2. `Given` 管理員啟用問卷，`When` 設定為「啟用」，`Then` 會員掃描發票後自動收到問卷連結
3. `Given` 管理員查看問卷回應，`When` 查詢特定問卷，`Then` 顯示所有回應和統計摘要

**業務規則**:
- 單一啟用：同時只能有一個問卷處於啟用狀態
- 題型支援：文字題、選擇題、評分題（1-5 星）
- 必填控制：可設定個別題目是否必填

#### **6.5 積分轉換規則管理**

**驗收條件**:
1. `Given` 管理員設定促銷期轉換率，`When` 輸入日期範圍和轉換率（如 50 元 = 1 點），`Then` 系統保存規則
2. `Given` 管理員變更規則後，`When` 保存，`Then` 系統顯示警告「需執行 make recalculate-points 重新計算所有積分」
3. `Given` 管理員查詢某日期的適用規則，`When` 輸入日期，`Then` 顯示該日期適用的轉換率

**業務規則**:
- 日期範圍：不可與現有規則重疊
- 轉換率範圍：1-1000（防止異常設定）
- 手動重算：規則變更後需手動執行 CLI 指令重算積分（避免高峰期鎖表）
- 優先順序：多個規則匹配時，使用創建時間最新的規則

---

## **3. 非功能性需求 (Non-Functional Requirements)**

### **3.1 性能 (Performance)**

| 功能 | 目標回應時間 | 說明 |
|------|------------|------|
| LINE Bot 互動 | < 2 秒 | 用戶發送訊息到收到回應 |
| QR Code 掃描 | < 5 秒 | 上傳圖片到顯示發票資訊 |
| 積分查詢 | < 1 秒 | 查詢積分餘額 |
| 管理後台列表頁 | < 3 秒 | 載入分頁列表 |
| iChef 批次匯入 | < 30 秒 / 1000 筆 | 匯入並驗證發票資料 |
| 積分全量重算 | < 5 秒 | 10K 使用者 + 500K 交易 |

### **3.2 穩定性與資料一致性 (Reliability)**

**可用性目標**:
*   系統核心服務可用性 ≥ 99.9%（每月最多 43 分鐘維護時間）
*   資料備份頻率：每日自動備份
*   災難恢復時間目標（RTO）：< 4 小時

**錯誤處理**:
*   與 LINE Platform 連接失敗：自動重試 3 次，指數退避
*   資料庫連接失敗：自動重試，提供降級服務（僅查詢功能）
*   QR Code 掃描失敗：提供清楚的錯誤提示和重試建議

**資料一致性**:
*   積分計算：確保交易狀態變更與積分更新的原子性
*   問卷提交：防止同一筆交易重複填寫問卷
*   發票驗證：防止同一發票重複登錄
*   並發控制：支援多用戶同時操作，避免資料競爭

### **3.3 安全性 (Security)**

**資料保護**:
*   個人資料加密：LINE ID、暱稱、手機號碼在儲存和傳輸時加密
*   密碼政策：管理後台使用 Google OAuth2 認證，無需自訂密碼
*   通訊加密：所有 HTTP 通訊強制使用 HTTPS

**訪問控制**:
*   LINE Bot：僅已註冊會員可使用積分功能
*   管理後台：基於角色的訪問控制（RBAC）
  - **Admin**: 完整權限
  - **User**: 唯讀權限
  - **Guest**: 受限唯讀
*   問卷系統：使用 Token-based 認證，Token 包含過期時間

**防護機制**:
*   重複掃描防護：資料庫唯一性約束
*   SQL 注入防護：使用參數化查詢
*   XSS 防護：輸入驗證和輸出編碼
*   CSRF 防護：使用 CSRF Token

### **3.4 可維護性 (Maintainability)**

**日誌與監控**:
*   結構化日誌
*   關鍵指標監控（回應時間、錯誤率、可用性）
*   告警機制（服務異常、性能下降）

**文件完整性**:
*   產品需求文件
*   系統設計文件
*   API 文件
*   部署運維文件

---

## **4. 版本範圍定義 (Scope Definition)**

### **V3.1 版本範圍內 (In Scope):**

#### **LINE Bot 功能**
*   **帳號綁定**: 透過手機號碼完成會員註冊
*   **QR Code 掃描**: 上傳照片掃描發票 QR Code 獲得積分
*   **積分餘額查詢**: 查詢當前累積積分
*   **問卷系統**: 完成問卷獲得 +1 點獎勵
*   **基礎錯誤處理**: 完善的錯誤提示和重試機制

#### **積分系統**
*   **動態轉換率**: 支援不同時期的積分轉換率設定
*   **問卷獎勵**: 完成問卷額外 +1 點
*   **交易驗證機制**: imported → verified → failed 狀態流程
*   **自動積分重算**: 交易狀態變更、問卷提交時自動重算
*   **手動積分重算**: CLI 工具支援全量重算

#### **POS 系統整合**
*   **iChef Excel 匯入**: 批次上傳發票資料
*   **智能匹配**: 自動比對發票號碼、日期、金額
*   **重複檢測**: 防止重複匯入
*   **雙向驗證**: QR 掃描 ↔ iChef 記錄自動關聯
*   **發票作廢處理**: 支援發票狀態更新並自動扣除積分

#### **管理後台**
*   **Google OAuth2 認證**: 安全的登入機制
*   **RBAC 權限控制**: Admin/User/Guest 三種角色
*   **會員管理**: 查看、搜尋會員資料
*   **交易管理**: 查看、搜尋、排序、手動更新交易狀態
*   **問卷管理**: 建立問卷、查看回應統計
*   **積分轉換規則管理**: 設定不同時期的轉換率
*   **iChef 匯入管理**: 查看匯入歷史與發票明細

### **超出當前版本範圍 (Out of Scope):**
*   **積分兌換功能**: 不包含積分折抵或兌換商品功能（計畫於 V3.2）
*   **用餐回饋系統**: 不包含星級評分或留言功能（已有問卷系統替代）
*   **員工核銷系統**: 不包含店員操作的網頁介面
*   **複雜的遊戲化機制**: 如每日簽到、任務挑戰等
*   **會員等級制度**: 不包含金卡、白金卡等分級功能
*   **線上點餐與支付**: 不包含點餐或金流功能
*   **行動應用程式**: 不包含 iOS/Android 原生 App（僅 LINE Bot + Web 管理後台）

### **未來可能發展方向 (Future Considerations):**
*   **V3.2**: 積分兌換現金折抵功能
*   **V3.3**: 優惠券功能
*   **V3.4**: 會員分級制度（根據消費金額或積分）
*   **V4.0**: 線上點餐系統整合
*   **V4.1**: 個人化推薦
*   **V5.0**: 獨立行動應用程式（iOS/Android）

---

## **5. 發布計畫**

### **Phase 1: MVP 核心功能 (已完成)**
- [x] 帳號綁定
- [x] QR Code 掃描
- [x] 積分餘額查詢
- [x] 基礎管理後台

### **Phase 2: 進階功能 (已完成)**
- [x] 問卷系統
- [x] 問卷獎勵機制
- [x] iChef POS 整合
- [x] 動態積分轉換率

### **Phase 3: 系統優化 (當前版本 V3.1)**
- [x] 資料模型優化
- [x] 積分計算邏輯優化
- [x] 錯誤處理完善
- [x] 系統穩定性提升

### **Phase 4: 未來發展 (V3.2+)**
- [ ] 積分兌換功能（V3.2）
- [ ] 優惠券系統（V3.3）
- [ ] 會員分級制度（V3.4）
- [ ] 線上點餐整合（V4.0）
- [ ] 個人化推薦（V4.1）

---

## **6. 附錄**

### **6.1 相關文件**

**產品文件**:
- 本文件（PRD.md）- 產品需求文件

**技術文件** (給開發團隊):
- SYSTEM_DESIGN.md - 系統架構設計
- DOMAIN_MODEL.md - 領域模型設計
- DATABASE_DESIGN.md - 資料庫設計
- ADMIN_API.md - 管理後台 API 文件
- DEPLOYMENT.md - 部署與配置管理

**開發文件**:
- README.md - 開發指南與快速上手
- CLAUDE.md - AI 助手開發指引

### **6.2 技術支援**
- **問題回報**: GitHub Issues
- **產品討論**: 團隊會議
- **文件更新**: 每次功能發布後同步更新

---

**文件版本**: V3.1
**最後更新**: 2025-01-08
**產品負責人**: Sarah
**維護者**: 產品團隊
